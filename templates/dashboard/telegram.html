{% extends 'base.html' %}
{% block title %}Ajustes Telegram{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h2 class="h4 mb-0">ğŸ“² Telegram</h2>
  <a href="{{ url_for('dashboard.index') }}" class="btn btn-sm btn-outline-secondary">â† Panel</a>
</div>

<!-- Estado de conexiÃ³n -->
<div class="card shadow-sm border-0 mb-3">
  <div class="card-header fw-semibold
    {% if estado.ok %}bg-success text-white{% else %}bg-danger text-white{% endif %}">
    {% if estado.ok %}âœ… Conectado{% else %}âŒ Sin conexiÃ³n{% endif %}
  </div>
  <div class="card-body">
    {% if estado.ok %}
      <p class="mb-1">ğŸ¤– Bot: <strong>@{{ estado.bot }}</strong></p>
      <p class="mb-0">ğŸ’¬ Chat ID: <code>{{ estado.chat_id }}</code></p>
    {% else %}
      <p class="text-danger fw-semibold mb-2">{{ estado.error }}</p>
      <div class="alert alert-warning mb-0 small">
        <strong>Para solucionarlo:</strong><br>
        1. Ve a <strong>@BotFather</strong> en Telegram â†’ <code>/mybots</code> â†’ tu bot â†’ <em>API Token</em> â†’ <em>Revoke</em><br>
        2. Copia el token nuevo en <code>.env</code> â†’ <code>TELEGRAM_BOT_TOKEN=...</code><br>
        3. Para el chat_id: escribe algo a tu bot y visita<br>
        <code>https://api.telegram.org/bot&lt;TOKEN&gt;/getUpdates</code><br>
        Busca <code>"chat":{"id": ESTE_NUMERO}</code>
      </div>
    {% endif %}
  </div>
</div>

<!-- Acciones manuales -->
<div class="card shadow-sm border-0 mb-3">
  <div class="card-header fw-semibold">âš¡ EnvÃ­os manuales</div>
  <div class="card-body d-flex flex-column gap-3">

    <!-- Test -->
    <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
      <div>
        <div class="fw-semibold">ğŸ”” Mensaje de prueba</div>
        <div class="text-muted small">Verifica que el bot te llega correctamente</div>
      </div>
      <button class="btn btn-outline-primary" onclick="accion('test', this)">Enviar prueba</button>
    </div>
    <hr class="my-0">

    <!-- Resumen del dÃ­a -->
    <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
      <div>
        <div class="fw-semibold">ğŸ“… Resumen del dÃ­a</div>
        <div class="text-muted small">Todas las citas de hoy con direcciÃ³n y telÃ©fono</div>
      </div>
      <button class="btn btn-outline-danger" onclick="accion('resumen', this)">Enviar resumen</button>
    </div>
    <hr class="my-0">

    <!-- Material pendiente -->
    <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
      <div>
        <div class="fw-semibold">ğŸ“¦ Recordatorio de material</div>
        <div class="text-muted small">Lista de avisos esperando piezas o material</div>
      </div>
      <button class="btn btn-outline-info" onclick="accion('material', this)">Enviar recordatorio</button>
    </div>

  </div>
</div>

<!-- Aviso .env -->
<div class="card shadow-sm border-0">
  <div class="card-header fw-semibold">âš™ï¸ ConfiguraciÃ³n</div>
  <div class="card-body small text-muted">
    <p class="mb-1">Los valores se guardan en <code>C:\g3v3r\CadizTecnico\.env</code></p>
    <pre class="bg-light p-2 rounded mb-0" style="font-size:0.78rem">TELEGRAM_BOT_TOKEN=tu_token_aqui
TELEGRAM_CHAT_ID=tu_chat_id_aqui</pre>
    <p class="mt-2 mb-0">âš ï¸ No compartas el token. Si lo expones regenera uno nuevo en @BotFather.</p>
  </div>
</div>

{% endblock %}

{% block scripts %}
<script>
function accion(tipo, btn) {
  const textos = {
    test: ['Enviando...', 'âœ… Enviado', 'âŒ Error al enviar'],
    resumen: ['Enviando resumen...', 'âœ… Resumen enviado', 'âŒ Error al enviar'],
    material: ['Enviando...', 'âœ… Enviado', 'âŒ Error (quizÃ¡s no hay material pendiente)'],
  };
  const [cargando, exito, error] = textos[tipo];
  const original = btn.textContent;
  btn.disabled = true;
  btn.textContent = cargando;

  fetch(`/dashboard/telegram/${tipo}`, { method: 'POST' })
    .then(r => r.json())
    .then(data => {
      btn.textContent = data.ok ? exito : error;
      btn.className = data.ok ? 'btn btn-success' : 'btn btn-danger';
      setTimeout(() => {
        btn.textContent = original;
        btn.className = btn.className.replace('btn-success','btn-outline-primary')
                                     .replace('btn-danger','btn-outline-primary');
        btn.disabled = false;
      }, 3000);
    })
    .catch(() => {
      btn.textContent = error;
      btn.disabled = false;
    });
}
</script>
{% endblock %}
